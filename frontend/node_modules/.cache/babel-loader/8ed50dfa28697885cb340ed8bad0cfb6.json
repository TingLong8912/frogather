{"ast":null,"code":"var __extends = this && this.__extends || function () {\n  var extendStatics = function (d, b) {\n    extendStatics = Object.setPrototypeOf || {\n      __proto__: []\n    } instanceof Array && function (d, b) {\n      d.__proto__ = b;\n    } || function (d, b) {\n      for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p];\n    };\n    return extendStatics(d, b);\n  };\n  return function (d, b) {\n    if (typeof b !== \"function\" && b !== null) throw new TypeError(\"Class extends value \" + String(b) + \" is not a constructor or null\");\n    extendStatics(d, b);\n    function __() {\n      this.constructor = d;\n    }\n    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n  };\n}();\n/**\n * @module ol/renderer/canvas/VectorImageLayer\n */\nimport CanvasImageLayerRenderer from './ImageLayer.js';\nimport CanvasVectorLayerRenderer from './VectorLayer.js';\nimport EventType from '../../events/EventType.js';\nimport ImageCanvas from '../../ImageCanvas.js';\nimport ImageState from '../../ImageState.js';\nimport RBush from 'rbush';\nimport ViewHint from '../../ViewHint.js';\nimport { apply, compose, create } from '../../transform.js';\nimport { assign } from '../../obj.js';\nimport { getHeight, getWidth, isEmpty, scaleFromCenter } from '../../extent.js';\n/**\n * @classdesc\n * Canvas renderer for image layers.\n * @api\n */\nvar CanvasVectorImageLayerRenderer = /** @class */function (_super) {\n  __extends(CanvasVectorImageLayerRenderer, _super);\n  /**\n   * @param {import(\"../../layer/VectorImage.js\").default} layer Vector image layer.\n   */\n  function CanvasVectorImageLayerRenderer(layer) {\n    var _this = _super.call(this, layer) || this;\n    /**\n     * @private\n     * @type {import(\"./VectorLayer.js\").default}\n     */\n    _this.vectorRenderer_ = new CanvasVectorLayerRenderer(layer);\n    /**\n     * @private\n     * @type {number}\n     */\n    _this.layerImageRatio_ = layer.getImageRatio();\n    /**\n     * @private\n     * @type {import(\"../../transform.js\").Transform}\n     */\n    _this.coordinateToVectorPixelTransform_ = create();\n    /**\n     * @private\n     * @type {import(\"../../transform.js\").Transform}\n     */\n    _this.renderedPixelToCoordinateTransform_ = null;\n    return _this;\n  }\n  /**\n   * Clean up.\n   */\n  CanvasVectorImageLayerRenderer.prototype.disposeInternal = function () {\n    this.vectorRenderer_.dispose();\n    _super.prototype.disposeInternal.call(this);\n  };\n  /**\n   * Asynchronous layer level hit detection.\n   * @param {import(\"../../pixel.js\").Pixel} pixel Pixel.\n   * @return {Promise<Array<import(\"../../Feature\").default>>} Promise that resolves with an array of features.\n   */\n  CanvasVectorImageLayerRenderer.prototype.getFeatures = function (pixel) {\n    if (!this.vectorRenderer_) {\n      return new Promise(function (resolve) {\n        return resolve([]);\n      });\n    }\n    var vectorPixel = apply(this.coordinateToVectorPixelTransform_, apply(this.renderedPixelToCoordinateTransform_, pixel.slice()));\n    return this.vectorRenderer_.getFeatures(vectorPixel);\n  };\n  /**\n   * Perform action necessary to get the layer rendered after new fonts have loaded\n   */\n  CanvasVectorImageLayerRenderer.prototype.handleFontsChanged = function () {\n    this.vectorRenderer_.handleFontsChanged();\n  };\n  /**\n   * Determine whether render should be called.\n   * @param {import(\"../../PluggableMap.js\").FrameState} frameState Frame state.\n   * @return {boolean} Layer is ready to be rendered.\n   */\n  CanvasVectorImageLayerRenderer.prototype.prepareFrame = function (frameState) {\n    var pixelRatio = frameState.pixelRatio;\n    var viewState = frameState.viewState;\n    var viewResolution = viewState.resolution;\n    var hints = frameState.viewHints;\n    var vectorRenderer = this.vectorRenderer_;\n    var renderedExtent = frameState.extent;\n    if (this.layerImageRatio_ !== 1) {\n      renderedExtent = renderedExtent.slice(0);\n      scaleFromCenter(renderedExtent, this.layerImageRatio_);\n    }\n    var width = getWidth(renderedExtent) / viewResolution;\n    var height = getHeight(renderedExtent) / viewResolution;\n    if (!hints[ViewHint.ANIMATING] && !hints[ViewHint.INTERACTING] && !isEmpty(renderedExtent)) {\n      vectorRenderer.useContainer(null, null);\n      var context = vectorRenderer.context;\n      var layerState = frameState.layerStatesArray[frameState.layerIndex];\n      context.globalAlpha = layerState.opacity;\n      var imageLayerState = assign({}, layerState, {\n        opacity: 1\n      });\n      var imageFrameState_1 = /** @type {import(\"../../PluggableMap.js\").FrameState} */assign({}, frameState, {\n        declutterTree: new RBush(9),\n        extent: renderedExtent,\n        size: [width, height],\n        viewState: (/** @type {import(\"../../View.js\").State} */assign({}, frameState.viewState, {\n          rotation: 0\n        })),\n        layerStatesArray: [imageLayerState],\n        layerIndex: 0\n      });\n      var emptyImage_1 = true;\n      var image_1 = new ImageCanvas(renderedExtent, viewResolution, pixelRatio, context.canvas, function (callback) {\n        if (vectorRenderer.prepareFrame(imageFrameState_1) && vectorRenderer.replayGroupChanged) {\n          vectorRenderer.clipping = false;\n          if (vectorRenderer.renderFrame(imageFrameState_1, null)) {\n            vectorRenderer.renderDeclutter(imageFrameState_1);\n            emptyImage_1 = false;\n          }\n          callback();\n        }\n      });\n      image_1.addEventListener(EventType.CHANGE, function () {\n        if (image_1.getState() !== ImageState.LOADED) {\n          return;\n        }\n        this.image_ = emptyImage_1 ? null : image_1;\n        var imageResolution = image_1.getResolution();\n        var imagePixelRatio = image_1.getPixelRatio();\n        var renderedResolution = imageResolution * pixelRatio / imagePixelRatio;\n        this.renderedResolution = renderedResolution;\n        this.coordinateToVectorPixelTransform_ = compose(this.coordinateToVectorPixelTransform_, width / 2, height / 2, 1 / renderedResolution, -1 / renderedResolution, 0, -viewState.center[0], -viewState.center[1]);\n      }.bind(this));\n      image_1.load();\n    }\n    if (this.image_) {\n      this.renderedPixelToCoordinateTransform_ = frameState.pixelToCoordinateTransform.slice();\n    }\n    return !!this.image_;\n  };\n  /**\n   */\n  CanvasVectorImageLayerRenderer.prototype.preRender = function () {};\n  /**\n   */\n  CanvasVectorImageLayerRenderer.prototype.postRender = function () {};\n  /**\n   */\n  CanvasVectorImageLayerRenderer.prototype.renderDeclutter = function () {};\n  /**\n   * @param {import(\"../../coordinate.js\").Coordinate} coordinate Coordinate.\n   * @param {import(\"../../PluggableMap.js\").FrameState} frameState Frame state.\n   * @param {number} hitTolerance Hit tolerance in pixels.\n   * @param {import(\"../vector.js\").FeatureCallback<T>} callback Feature callback.\n   * @param {Array<import(\"../Map.js\").HitMatch<T>>} matches The hit detected matches with tolerance.\n   * @return {T|undefined} Callback result.\n   * @template T\n   */\n  CanvasVectorImageLayerRenderer.prototype.forEachFeatureAtCoordinate = function (coordinate, frameState, hitTolerance, callback, matches) {\n    if (this.vectorRenderer_) {\n      return this.vectorRenderer_.forEachFeatureAtCoordinate(coordinate, frameState, hitTolerance, callback, matches);\n    } else {\n      return _super.prototype.forEachFeatureAtCoordinate.call(this, coordinate, frameState, hitTolerance, callback, matches);\n    }\n  };\n  return CanvasVectorImageLayerRenderer;\n}(CanvasImageLayerRenderer);\nexport default CanvasVectorImageLayerRenderer;","map":{"version":3,"names":["CanvasImageLayerRenderer","CanvasVectorLayerRenderer","EventType","ImageCanvas","ImageState","RBush","ViewHint","apply","compose","create","assign","getHeight","getWidth","isEmpty","scaleFromCenter","CanvasVectorImageLayerRenderer","_super","__extends","layer","_this","call","vectorRenderer_","layerImageRatio_","getImageRatio","coordinateToVectorPixelTransform_","renderedPixelToCoordinateTransform_","prototype","disposeInternal","dispose","getFeatures","pixel","Promise","resolve","vectorPixel","slice","handleFontsChanged","prepareFrame","frameState","pixelRatio","viewState","viewResolution","resolution","hints","viewHints","vectorRenderer","renderedExtent","extent","width","height","ANIMATING","INTERACTING","useContainer","context","layerState","layerStatesArray","layerIndex","globalAlpha","opacity","imageLayerState","imageFrameState_1","declutterTree","size","rotation","emptyImage_1","image_1","canvas","callback","replayGroupChanged","clipping","renderFrame","renderDeclutter","addEventListener","CHANGE","getState","LOADED","image_","imageResolution","getResolution","imagePixelRatio","getPixelRatio","renderedResolution","center","bind","load","pixelToCoordinateTransform","preRender","postRender","forEachFeatureAtCoordinate","coordinate","hitTolerance","matches"],"sources":["../../src/renderer/canvas/VectorImageLayer.js"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module"}